#
# -----------------------------------------------------------
#                    Dockerfile.agent
#
#  This blueprint builds our "General Purpose Worker".
#  It starts from the base Jenkins agent image and "harvests"
#  all the complex toolchains from our dev-container to
#  create a "polyglot" builder.
#
#  It is a "cattle" image: stateless, disposable, but
#  loaded with all the tools our "hero project" needs.
# -----------------------------------------------------------

# 1. Start from the official Jenkins agent image (Debian 12 + JDK 17)
FROM jenkins/agent:latest-jdk21
LABEL authors="warren_jitsing"

# 2. Get ARGs from our dev-container for custom builds
ARG py312="3.12.12"
ARG py313="3.13.9"
ARG py314="3.14.0"
ARG gcc15="15.2.0"

# 3. Switch to 'root' to install everything
USER root

# 4. Copy our Local CA cert from the build context
# (Our '01-setup-jenkins.sh' will place this file here)
COPY ca.pem /tmp/ca.pem

# 5. Install all OS dependencies (harvested from dev-container + hero project)
# This includes base tools, "hero project" deps, and Python build deps
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential ca-certificates cmake curl flex \
    git git-lfs gnupg2 sudo wget unzip \
    llvm lcov hyperfine libcurl4-openssl-dev libboost-all-dev \
    libbz2-dev libffi-dev libgdbm-compat-dev libgdbm-dev liblzma-dev \
    libncurses5-dev libreadline-dev libsqlite3-dev libssl-dev \
    python3-dev python3-pip python3-tk uuid-dev zlib1g-dev \
    m4 patch pkg-config procps \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# 6. Build and install custom GCC
RUN mkdir -p /tmp/deps/gcc \
    && cd /tmp/deps/gcc \
    && curl -fsSL "https://github.com/gcc-mirror/gcc/archive/refs/tags/releases/gcc-${gcc15}.tar.gz" | tar -xz --strip-components=1 \
    && ./contrib/download_prerequisites \
    && mkdir build && cd build \
    && ../configure --disable-multilib --enable-languages=c,c++ \
    && make -j $(nproc) \
    && make install \
    && cd / \
    && rm -rf /tmp/deps

# 7. Add our new custom GCC to the system-wide PATH
RUN echo 'export PATH="/usr/local/bin:${PATH}"' > /etc/profile.d/gcc.sh \
    && echo 'export LD_LIBRARY_PATH="/usr/local/lib64:${LD_LIBRARY_PATH}"' >> /etc/profile.d/gcc.sh

# 8. Build and install custom Python versions
RUN for version in $py312 $py313 $py314; do \
        echo "--- Building Python version ${version} ---"; \
        mkdir -p /tmp/deps/python; \
        cd /tmp/deps/python; \
        curl -fsSL "https://github.com/python/cpython/archive/refs/tags/v${version}.tar.gz" | tar -xz --strip-components=1; \
        CONFIGURE_FLAGS="--enable-optimizations --enable-loadable-sqlite-extensions --with-lto=full"; \
        if [ "$version" = "$py313" ] || [ "$version" = "$py314" ]; then \
            echo "--- Adding --disable-gil flag for nogil build ---"; \
            CONFIGURE_FLAGS="$CONFIGURE_FLAGS --disable-gil"; \
        fi; \
        ./configure $CONFIGURE_FLAGS; \
        make -j $(nproc); \
        make altinstall; \
        cd / ; \
    done \
    && rm -rf /tmp/deps

RUN echo "export CC=/usr/local/bin/gcc" >> /root/.bashrc \
    && echo "export CXX=/usr/local/bin/g++" >> /root/.bashrc \
    && echo "export CC=/usr/local/bin/gcc" >> /home/jenkins/.bashrc \
    && echo "export CXX=/usr/local/bin/g++" >> /home/jenkins/.bashrc

ENV CC="/usr/local/bin/gcc"
ENV CXX="/usr/local/bin/g++"
ENV LD_LIBRARY_PATH="/usr/local/lib64:${LD_LIBRARY_PATH}"

# 9. Install SonarScanner CLI (as root)
RUN wget -O /tmp/sonar.zip "https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-7.3.0.5189-linux-x64.zip" \
    && unzip /tmp/sonar.zip -d /opt \
    && mv /opt/sonar-scanner-* /opt/sonar-scanner \
    && ln -s /opt/sonar-scanner/bin/sonar-scanner /usr/bin/sonar-scanner \
    && rm /tmp/sonar.zip

# 10. Fix CA Trust (for both OS/git and JVM) (as root)
RUN cp /tmp/ca.pem /usr/local/share/ca-certificates/cicd-stack-ca.crt \
    && update-ca-certificates \
    && keytool -importcert \
        -keystore /opt/java/openjdk/lib/security/cacerts \
        -storepass changeit \
        -file /tmp/ca.pem \
        -alias "CICD-Root-CA" \
        -noprompt \
    && rm /tmp/ca.pem

# 11. Switch to the default agent user
USER jenkins

# 12. Install user-specific toolchains (Rust and Julia)
RUN curl https://sh.rustup.rs -sSf | sh -s -- -y \
    && curl -fsSL https://install.julialang.org | sh -s -- -y

# 13. Install cargo-llvm-cov
# We must source the env file in the *same* command
RUN . "$HOME/.cargo/env" && cargo install cargo-llvm-cov

# 14. Add the new toolchains to the container's PATH
# This ENV instruction makes them available to all subsequent
# Jenkins 'sh' steps.
ENV PATH="/home/jenkins/.cargo/bin:/home/jenkins/.juliaup/bin:${PATH}"

# 15. Set the Entrypoint (must be last)
ENTRYPOINT ["java", "-jar", "/usr/share/jenkins/agent.jar"]