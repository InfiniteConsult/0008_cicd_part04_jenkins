#
# -----------------------------------------------------------
#               Dockerfile.controller
#
#  This blueprint builds our "Foreman" (Jenkins Controller).
#
#  1. DooD: Installs Docker CLI & fixes GID permissions.
#  2. CA Trust: Bakes in our Local CA to the JVM trust store.
#  3. Plugins: Installs all plugins from 'plugins.txt'.
#
# -----------------------------------------------------------

# 1. Start from the official Jenkins Long-Term Support image
FROM jenkins/jenkins:lts-jdk21
LABEL authors="warren_jitsing"

# 2. Accept the host's 'docker' GID as a build-time argument
ARG HOST_DOCKER_GID

# 3. Switch to 'root' to install software and fix permissions
USER root

# 4. Copy our Local CA cert from the build context
# (Our '01-setup-jenkins.sh' will place this file here)
COPY ca.pem /tmp/ca.pem

# 5. Fix CA Trust (for both OS/git and JVM)
# This is "baked in" for simplicity and robustness
RUN cp /tmp/ca.pem /usr/local/share/ca-certificates/cicd-stack-ca.crt \
    && update-ca-certificates \
    && keytool -importcert \
        -keystore /opt/java/openjdk/lib/security/cacerts \
        -storepass changeit \
        -file /tmp/ca.pem \
        -alias "CICD-Root-CA" \
        -noprompt \
    && rm /tmp/ca.pem

# 6. Install Docker CLI & Fix GID Mismatch
RUN apt-get update && apt-get install -y --no-install-recommends \
        curl \
        gnupg \
    && install -m 0755 -d /etc/apt/keyrings \
    && curl -fsSL https://download.docker.com/linux/debian/gpg -o /etc/apt/keyrings/docker.asc \
    && chmod a+r /etc/apt/keyrings/docker.asc \
    && echo \
      "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/debian \
      $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
      tee /etc/apt/sources.list.d/docker.list > /dev/null \
    && apt-get update && apt-get install -y --no-install-recommends \
        docker-ce-cli \
    && groupadd --gid $HOST_DOCKER_GID docker \
    && usermod -aG docker jenkins \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# 7. Switch back to the unprivileged 'jenkins' user
USER jenkins

# 8. Copy our plugin list into the official ref directory
COPY plugins.txt /usr/share/jenkins/ref/plugins.txt

# 9. Run the official plugin installer script
RUN jenkins-plugin-cli -f /usr/share/jenkins/ref/plugins.txt
